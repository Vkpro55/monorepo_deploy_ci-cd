FROM oven/bun:1

WORKDIR /usr/src/app

ARG DATABASE_URL

# Copy root configs
COPY bun.lock package.json turbo.json ./
COPY packages ./packages
COPY apps/web ./apps/web

# Install ALL dependencies (including prisma + @prisma/client from root)
RUN bun install 

# Generate Prisma client (no migrations)
RUN bun run db:generate

EXPOSE 3000

ENTRYPOINT ["sh", "-c", "bunx prisma migrate deploy && exec bun run start:web"]
